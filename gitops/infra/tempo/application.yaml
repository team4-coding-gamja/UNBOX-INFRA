apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: tempo
  namespace: argocd
  labels:
    type: infrastructure
    component: distributed-tracing
  annotations:
    argocd.argoproj.io/sync-wave: "5"  # Kafka 다음에 배포
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: tempo
    targetRevision: 1.7.2
    helm:
      releaseName: tempo
      values: |
        # 이미지 설정
        image:
          repository: grafana/tempo
          tag: 2.3.1
        
        # 서비스 설정
        service:
          type: ClusterIP
        
        # Zipkin 호환 엔드포인트 활성화
        tempo:
          receivers:
            zipkin:
              endpoint: 0.0.0.0:9411
            jaeger:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:14250
            otlp:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:4317
                http:
                  endpoint: 0.0.0.0:4318
          
          storage:
            trace:
              backend: local
              local:
                path: /tmp/tempo/traces
        
        # 리소스 제한
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        
        # Replica 설정
        replicas: 1
        
        # 스토리지 비활성화 (로컬 환경)
        persistence:
          enabled: false
  destination:
    server: https://kubernetes.default.svc
    namespace: unbox-infra
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 3
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
