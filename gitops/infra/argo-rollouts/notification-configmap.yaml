apiVersion: v1
kind: ConfigMap
metadata:
  name: argo-rollouts-notification-configmap
  namespace: argo-rollouts
data:
  # Discord ì„œë¹„ìŠ¤ ì„¤ì •
  service.discord: |
    token: $discord-token
  
  # Discord Webhook URL (Secretì—ì„œ ì°¸ì¡°)
  # kubectl create secret generic argo-rollouts-notification-secret \
  #   --from-literal=discord-token=<YOUR_DISCORD_WEBHOOK_URL> \
  #   -n argo-rollouts
  
  # Rollout Paused ì•Œë¦¼ í…œí”Œë¦¿
  template.rollout-paused: |
    webhook:
      discord:
        method: POST
        path: /api/webhooks/{{.secret.discord-token}}
        body: |
          {
            "embeds": [{
              "title": "ğŸš¨ Payment Service ë°°í¬ ìŠ¹ì¸ ëŒ€ê¸°",
              "description": "Manual Approvalì´ í•„ìš”í•©ë‹ˆë‹¤",
              "color": 16776960,
              "fields": [
                {
                  "name": "ì„œë¹„ìŠ¤",
                  "value": "{{.rollout.metadata.name}}",
                  "inline": true
                },
                {
                  "name": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤",
                  "value": "{{.rollout.metadata.namespace}}",
                  "inline": true
                },
                {
                  "name": "í˜„ì¬ ë‹¨ê³„",
                  "value": "{{.rollout.status.currentStepIndex}}/{{.rollout.spec.strategy.canary.steps | len}}",
                  "inline": true
                },
                {
                  "name": "Canary íŠ¸ë˜í”½",
                  "value": "{{.rollout.status.canary.weights.canary}}%",
                  "inline": true
                },
                {
                  "name": "ìƒíƒœ",
                  "value": "â¸ï¸ Paused - Manual Approval í•„ìš”",
                  "inline": false
                },
                {
                  "name": "ğŸ“Š í™•ì¸ ì‚¬í•­",
                  "value": "â€¢ Grafana ëŒ€ì‹œë³´ë“œì—ì„œ ë©”íŠ¸ë¦­ í™•ì¸\nâ€¢ ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ ê±´ìˆ˜\nâ€¢ PGì‚¬ë³„ ì‘ë‹µ ì‹œê°„\nâ€¢ í™˜ë¶ˆ ì²˜ë¦¬ ì •ìƒ ì—¬ë¶€",
                  "inline": false
                },
                {
                  "name": "âœ… ìŠ¹ì¸",
                  "value": "`kubectl argo rollouts promote {{.rollout.metadata.name}} -n {{.rollout.metadata.namespace}}`",
                  "inline": false
                },
                {
                  "name": "âŒ ê±°ë¶€ (ë¡¤ë°±)",
                  "value": "`kubectl argo rollouts abort {{.rollout.metadata.name}} -n {{.rollout.metadata.namespace}}`",
                  "inline": false
                }
              ],
              "timestamp": "{{.rollout.status.conditions[0].lastUpdateTime}}"
            }]
          }
  
  # Rollout Completed ì•Œë¦¼ í…œí”Œë¦¿
  template.rollout-completed: |
    webhook:
      discord:
        method: POST
        path: /api/webhooks/{{.secret.discord-token}}
        body: |
          {
            "embeds": [{
              "title": "âœ… Payment Service ë°°í¬ ì™„ë£Œ",
              "description": "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
              "color": 65280,
              "fields": [
                {
                  "name": "ì„œë¹„ìŠ¤",
                  "value": "{{.rollout.metadata.name}}",
                  "inline": true
                },
                {
                  "name": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤",
                  "value": "{{.rollout.metadata.namespace}}",
                  "inline": true
                },
                {
                  "name": "ìƒíƒœ",
                  "value": "âœ… Healthy - 100% íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ",
                  "inline": false
                }
              ],
              "timestamp": "{{.rollout.status.conditions[0].lastUpdateTime}}"
            }]
          }
  
  # Rollout Aborted ì•Œë¦¼ í…œí”Œë¦¿
  template.rollout-aborted: |
    webhook:
      discord:
        method: POST
        path: /api/webhooks/{{.secret.discord-token}}
        body: |
          {
            "embeds": [{
              "title": "âŒ Payment Service ë°°í¬ ì¤‘ë‹¨",
              "description": "ë°°í¬ê°€ ì¤‘ë‹¨ë˜ê³  ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤",
              "color": 16711680,
              "fields": [
                {
                  "name": "ì„œë¹„ìŠ¤",
                  "value": "{{.rollout.metadata.name}}",
                  "inline": true
                },
                {
                  "name": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤",
                  "value": "{{.rollout.metadata.namespace}}",
                  "inline": true
                },
                {
                  "name": "ì¤‘ë‹¨ ë‹¨ê³„",
                  "value": "{{.rollout.status.currentStepIndex}}/{{.rollout.spec.strategy.canary.steps | len}}",
                  "inline": true
                },
                {
                  "name": "ìƒíƒœ",
                  "value": "ğŸ”„ Rollback ì™„ë£Œ - ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ë¨",
                  "inline": false
                }
              ],
              "timestamp": "{{.rollout.status.conditions[0].lastUpdateTime}}"
            }]
          }
  
  # íŠ¸ë¦¬ê±° ì„¤ì •
  trigger.on-rollout-paused: |
    - when: rollout.spec.paused == true
      send: [rollout-paused]
  
  trigger.on-rollout-completed: |
    - when: rollout.status.phase == 'Healthy'
      send: [rollout-completed]
  
  trigger.on-rollout-aborted: |
    - when: rollout.status.phase == 'Degraded' || rollout.status.abort == true
      send: [rollout-aborted]
