# Argo Rollouts ê´€ë ¨ ì•Œë¦¼ ê·œì¹™
apiVersion: v1
kind: ConfigMap
metadata:
  name: rollout-alerts
  namespace: unbox-monitoring
  labels:
    grafana_alert: "1"
data:
  rollout-alerts.yaml: |
    groups:
      - name: rollouts
        interval: 30s
        rules:
          # Rollout ì‹œì‘ (Canary/Blue-Green)
          - alert: Rollout_Started
            expr: |
              rollout_phase{phase="Progressing"} == 1
            labels:
              severity: cd
              component: rollout
            annotations:
              summary: "ğŸš€ Rollout ì‹œì‘"
              description: "ì„œë¹„ìŠ¤ {{ $labels.rollout }}ì˜ {{ $labels.strategy }} ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # Canary ë¶„ì„ ì¤‘
          - alert: Rollout_Canary_Analysis
            expr: |
              rollout_phase{phase="Progressing"} == 1 
              and rollout_info{strategy="canary"} == 1
            for: 1m
            labels:
              severity: cd
              component: rollout
            annotations:
              summary: "ğŸ” Canary ë¶„ì„ ì¤‘"
              description: "ì„œë¹„ìŠ¤ {{ $labels.rollout }}ì˜ Canary Podë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ê°€ì¤‘ì¹˜: {{ $labels.canary_weight }}%)"
          
          # Rollout ìë™ ë¡¤ë°±
          - alert: Rollout_Auto_Rollback
            expr: |
              increase(rollout_phase{phase="Degraded"}[2m]) > 0
            labels:
              severity: critical
              component: rollout
            annotations:
              summary: "ğŸ”„ ìë™ ë¡¤ë°± ë°œìƒ"
              description: "ì„œë¹„ìŠ¤ {{ $labels.rollout }}ì—ì„œ ë¬¸ì œê°€ ê°ì§€ë˜ì–´ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # Rollout ì™„ë£Œ
          - alert: Rollout_Completed
            expr: |
              increase(rollout_phase{phase="Healthy"}[1m]) > 0
            labels:
              severity: cd
              component: rollout
            annotations:
              summary: "âœ… Rollout ì™„ë£Œ"
              description: "ì„œë¹„ìŠ¤ {{ $labels.rollout }}ì˜ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # Rollout ì¤‘ë‹¨ (ìˆ˜ë™)
          - alert: Rollout_Aborted
            expr: |
              increase(rollout_phase{phase="Paused"}[5m]) > 0
            for: 5m
            labels:
              severity: warning
              component: rollout
            annotations:
              summary: "â¸ï¸ Rollout ì¤‘ë‹¨ë¨"
              description: "ì„œë¹„ìŠ¤ {{ $labels.rollout }}ì˜ ë°°í¬ê°€ 5ë¶„ ì´ìƒ ì¤‘ë‹¨ ìƒíƒœì…ë‹ˆë‹¤. ìˆ˜ë™ ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
          
          # Canary ë¶„ì„ ì‹¤íŒ¨ìœ¨ ë†’ìŒ
          - alert: Canary_High_Error_Rate
            expr: |
              (
                sum(rate(http_requests_total{status=~"5..", rollouts_pod_template_hash!=""}[5m])) by (service, rollouts_pod_template_hash)
                /
                sum(rate(http_requests_total{rollouts_pod_template_hash!=""}[5m])) by (service, rollouts_pod_template_hash)
              ) * 100 > 5
            for: 2m
            labels:
              severity: critical
              component: rollout
            annotations:
              summary: "ğŸš¨ Canary ì—ëŸ¬ìœ¨ ë†’ìŒ"
              description: "ì„œë¹„ìŠ¤ {{ $labels.service }}ì˜ Canary Pod ì—ëŸ¬ìœ¨ì´ {{ $value | humanize }}%ì…ë‹ˆë‹¤. (ì„ê³„ê°’: 5%)"
          
          # Canary ë¶„ì„ ì„±ê³µë¥  ë‚®ìŒ
          - alert: Canary_Low_Success_Rate
            expr: |
              (
                sum(rate(http_requests_total{status=~"2..", rollouts_pod_template_hash!=""}[5m])) by (service, rollouts_pod_template_hash)
                /
                sum(rate(http_requests_total{rollouts_pod_template_hash!=""}[5m])) by (service, rollouts_pod_template_hash)
              ) * 100 < 95
            for: 2m
            labels:
              severity: critical
              component: rollout
            annotations:
              summary: "ğŸš¨ Canary ì„±ê³µë¥  ë‚®ìŒ"
              description: "ì„œë¹„ìŠ¤ {{ $labels.service }}ì˜ Canary Pod ì„±ê³µë¥ ì´ {{ $value | humanize }}%ì…ë‹ˆë‹¤. (ì„ê³„ê°’: 95%)"
          
          # Canary ì‘ë‹µ ì‹œê°„ ëŠë¦¼
          - alert: Canary_Slow_Response
            expr: |
              histogram_quantile(0.95,
                sum(rate(http_request_duration_seconds_bucket{rollouts_pod_template_hash!=""}[5m])) by (service, rollouts_pod_template_hash, le)
              ) > 1
            for: 3m
            labels:
              severity: warning
              component: rollout
            annotations:
              summary: "âš ï¸ Canary ì‘ë‹µ ì‹œê°„ ëŠë¦¼"
              description: "ì„œë¹„ìŠ¤ {{ $labels.service }}ì˜ Canary Pod P95 ì‘ë‹µ ì‹œê°„ì´ {{ $value | humanize }}ì´ˆì…ë‹ˆë‹¤. (ì„ê³„ê°’: 1ì´ˆ)"
