apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
    - name: Content-Type
      value: application/json

  # Rollout ë°°í¬ ì„±ê³µ ì•Œë¦¼
  template.rollout-healthy: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "âœ… Rollout ë°°í¬ ì™„ë£Œ",
              "description": "**ì„œë¹„ìŠ¤:** `{{.app.metadata.name}}`\n**ì´ë¯¸ì§€:** `{{(call .app.status.summary.images)}}`\n**ìƒíƒœ:** Healthy",
              "color": 3066993,
              "fields": [
                {
                  "name": "Sync Status",
                  "value": "{{.app.status.sync.status}}",
                  "inline": true
                },
                {
                  "name": "Health Status",
                  "value": "{{.app.status.health.status}}",
                  "inline": true
                }
              ],
              "footer": {
                "text": "ArgoCD Rollout Notification"
              },
              "timestamp": "{{.app.status.operationState.finishedAt}}"
            }]
          }

  # Rollout ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
  template.rollout-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "âŒ Rollout ë°°í¬ ì‹¤íŒ¨",
              "description": "**ì„œë¹„ìŠ¤:** `{{.app.metadata.name}}`\n**ì´ë¯¸ì§€:** `{{(call .app.status.summary.images)}}`\n**ìƒíƒœ:** Degraded\n**ì›ì¸:** AnalysisRun ì‹¤íŒ¨ ë˜ëŠ” í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨",
              "color": 15158332,
              "fields": [
                {
                  "name": "Sync Status",
                  "value": "{{.app.status.sync.status}}",
                  "inline": true
                },
                {
                  "name": "Health Status",
                  "value": "{{.app.status.health.status}}",
                  "inline": true
                }
              ],
              "footer": {
                "text": "ArgoCD Rollout Notification"
              },
              "timestamp": "{{.app.status.operationState.finishedAt}}"
            }]
          }

  # Rollout ì§„í–‰ ì¤‘ ì•Œë¦¼
  template.rollout-progressing: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "ğŸ”„ Rollout ë°°í¬ ì§„í–‰ ì¤‘",
              "description": "**ì„œë¹„ìŠ¤:** `{{.app.metadata.name}}`\n**ì´ë¯¸ì§€:** `{{(call .app.status.summary.images)}}`\n**ìƒíƒœ:** Progressing (Canary ë°°í¬ ì¤‘)",
              "color": 3447003,
              "footer": {
                "text": "ArgoCD Rollout Notification"
              },
              "timestamp": "{{.app.status.operationState.startedAt}}"
            }]
          }

  # íŠ¸ë¦¬ê±° ì„¤ì •
  trigger.on-health-degraded: |
    - description: Application has degraded
      send:
      - rollout-degraded
      when: app.status.health.status == 'Degraded'

  trigger.on-deployed: |
    - description: Application is synced and healthy
      send:
      - rollout-healthy
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'

  trigger.on-sync-running: |
    - description: Application is being synced
      send:
      - rollout-progressing
      when: app.status.operationState.phase in ['Running']
