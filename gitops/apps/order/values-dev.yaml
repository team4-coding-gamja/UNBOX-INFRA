# Order Service - Dev Environment
appName: order-service
replicaCount: 1
image:
  repository: 632941626317.dkr.ecr.ap-northeast-2.amazonaws.com/unbox-dev-order-repo
  tag: dev-33d4179e113c195846a0cd2e800dedd9f544f356
  pullPolicy: Always
# Ingress 활성화
ingress:
  enabled: false
linkerd:
  enabled: true # Linkerd Service Mesh 활성화
service:
  port: 80
  targetPort: 8084
  annotations:
    alb.ingress.kubernetes.io/healthcheck-path: "/order/actuator/health"
containerPort: 8084
env:
  SERVER_PORT: "8084"
  SERVER_SERVLET_CONTEXT_PATH: "/order"
  SERVER_TOMCAT_ACCESSLOG_ENABLED: "true"
  SPRING_JWT_SECRET:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: JWT_SECRET
  DB_DRIVER_CLASS_NAME: "org.postgresql.Driver"
  SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
  SPRING_JPA_SHOW_SQL: "false"
  SPRING_DATASOURCE_URL:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: RDS_ENDPOINT
  SPRING_DATASOURCE_USERNAME: "unbox_admin"
  SPRING_DATASOURCE_PASSWORD:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: DB_PASSWORD
  SPRING_DATA_REDIS_HOST:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: REDIS_ENDPOINT
  SPRING_DATA_REDIS_PORT: "6379"
  SPRING_DATA_REDIS_SSL: "true"
  SPRING_DATA_REDIS_PASSWORD:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: REDIS_PASSWORD
  SPRING_KAFKA_BOOTSTRAP_SERVERS:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: KAFKA_ENDPOINT
  # Tracing 활성화 (Tempo)
  MANAGEMENT_TRACING_ENABLED: "true"
  TEMPO_OTLP_ENDPOINT: "http://tempo.monitoring.svc.cluster.local:4318/v1/traces"
resources:
  requests:
    memory: "512Mi"
    cpu: "100m"
  limits:
    memory: "1Gi"
rollout:
  enabled: true
  strategy: "canary"
  healthCheck:
    enabled: true
    path: "/order/actuator/health"
    periodSeconds: 10
    startupProbe:
      failureThreshold: 60
      periodSeconds: 10
  # Analysis 활성화 - 완전 자동화된 Canary 배포
  analysis:
    enabled: true
    startingStep: 1 # 첫 번째 카나리 단계부터 분석 시작
    interval: 30s # 30초마다 메트릭 체크
    successRate: 95 # 성공률 95% 이상
    errorRate: 5 # 에러율 5% 이하
    avgResponseTime: 1000 # 평균 응답시간 1초 이하
    failureLimit: 3 # 3번 실패 시 자동 롤백
    queryRange: 1m # 1분간의 메트릭 분석
    prometheusAddress: http://kube-prometheus-stack-prometheus.monitoring:9090
  canary:
    canaryService: order-service-canary
    stableService: order-service-stable
    trafficRouting:
      smi:
        rootService: order-service
    # Tier 1 - 안정적 확장: 5% → 25% → 50% → 100%
    steps:
      - setWeight: 5
      - pause: {duration: 30s} # 테스트용 단축
      - setWeight: 25
      - pause: {duration: 30s}
      - setWeight: 50
      - pause: {duration: 30s}
      - setWeight: 100
    maxSurge: "25%"
    maxUnavailable: 0
