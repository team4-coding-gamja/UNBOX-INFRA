# Trade Service - Local k3d 환경 오버라이드
image:
  repository: 632941626317.dkr.ecr.ap-northeast-2.amazonaws.com/unbox-dev-trade-repo
  tag: dev-0ba83c114ebe11e6e89b1d9541a611d06049d7d6

env:
  SPRING_JWT_SECRET: "c2VjcmV0S2V5Rm9yTG9jYWxEZXZlbG9wbWVudFRoaXNJc1ZlcnlJbXBvcnRhbnQ="
  SPRING_JPA_SHOW_SQL: "true"  # 로컬에서는 SQL 로그 활성화
  
  # 로컬 PostgreSQL 사용
  SPRING_DATASOURCE_URL: "jdbc:postgresql://postgresql.unbox-db.svc.cluster.local:5432/unbox_trade"
  SPRING_DATASOURCE_USERNAME: "unbox_admin"
  SPRING_DATASOURCE_PASSWORD: "local_password_123"
  
  # 로컬 Kafka
  SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka.unbox-infra.svc.cluster.local:9092"
  
  # 로컬 Redis 사용
  SPRING_DATA_REDIS_HOST: "redis-master.unbox-db.svc.cluster.local"
  SPRING_DATA_REDIS_PORT: "6379"
  
  # 로컬 Zipkin
  MANAGEMENT_ZIPKIN_TRACING_ENDPOINT: "http://zipkin.unbox-infra.svc.cluster.local:9411/api/v2/spans"
  
  # 로컬 환경 시작 속도 최적화
  SPRING_MAIN_LAZY_INITIALIZATION: "true"
  SPRING_JPA_PROPERTIES_HIBERNATE_TEMP_USE_JDBC_METADATA_DEFAULTS: "false"
  SPRING_DATA_JPA_REPOSITORIES_BOOTSTRAP_MODE: "lazy"
  JAVA_TOOL_OPTIONS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:InitialRAMPercentage=50.0 -XX:+TieredCompilation -XX:TieredStopAtLevel=1"

# 로컬 환경 리소스 최적화 (빠른 시작을 위해)
resources:
  requests:
    memory: "512Mi"
    cpu: "100m"  # 낮게 설정해서 시작 시 CPU 제한 완화
  limits:
    memory: "1024Mi"
    # cpu limit 제거 - 시작할 때 맘껏 쓰게 함

# Argo Rollouts 설정 (Local 환경 - Canary 빠른 테스트)
rollout:
  enabled: true
  canary:
    steps:
    - setWeight: 50   # 50% 트래픽
    - pause: {duration: 30s}  # 30초 대기
  analysis:
    enabled: false  # 로컬에서는 analysis 비활성화
  healthCheck:
    enabled: true
    path: /trade/actuator/health  # context path 포함
    # startupProbe 사용 - 앱이 뜨자마자 즉시 다음 단계로
    startupProbe:
      failureThreshold: 30  # 30번 실패까지 허용 (30 * 10초 = 최대 5분)
      periodSeconds: 10     # 10초마다 체크
    initialDelaySeconds: 0  # startupProbe 사용 시 불필요
    periodSeconds: 10
