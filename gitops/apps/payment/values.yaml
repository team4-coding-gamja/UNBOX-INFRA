# Payment Service - 공통 기본값
appName: payment-service
contextPath: /payment
replicaCount: 1
contextPath: /payment

image:
  repository: ""  # 환경별로 오버라이드
  tag: latest
  pullPolicy: Always

# Ingress 설정
ingress:
  enabled: false
  path: /payment
  groupName: unbox-dev


# 서비스 메시 설정
linkerd:
  enabled: false  # 기본값은 비활성화

service:
  port: 80
  targetPort: 8085

containerPort: 8085

# 공통 환경변수
env:
  SERVER_PORT: "8085"
  SERVER_SERVLET_CONTEXT_PATH: "/payment"
  SPRING_JWT_SECRET:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: JWT_SECRET
  DB_DRIVER_CLASS_NAME: "org.postgresql.Driver"
  SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
  SPRING_JPA_SHOW_SQL: "false"
  
  # 기본 연결 설정 (환경별로 오버라이드)
  SPRING_DATASOURCE_URL: ""
  SPRING_DATASOURCE_USERNAME: ""
  SPRING_KAFKA_BOOTSTRAP_SERVERS: ""
  SPRING_DATA_REDIS_HOST: ""
  SPRING_DATA_REDIS_PORT: "6379"
  SPRING_DATA_REDIS_SSL: "true"
  SPRING_DATA_REDIS_PASSWORD:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: REDIS_PASSWORD
  
  # Zipkin 연결
  MANAGEMENT_ZIPKIN_TRACING_ENDPOINT: "http://zipkin.unbox-infra.svc.cluster.local:9411/api/v2/spans"
  TOSS_SECRET_KEY: "test_sk_vZnjEJeQVxJj574wXDnP8PmOoBN0"
  TOSS_SECURITY_KEY: "1bca83b538ebfacd601d91c295f2cc6e24dfde5b0705550473ac1a74fed0dd09"
  TEMPO_OTLP_ENDPOINT: "http://tempo.monitoring.svc.cluster.local:4318/v1/traces"
  USER_SERVICE_URL: "http://user-service.unbox-app"
  PRODUCT_SERVICE_URL: "http://product-service.unbox-app"
  ORDER_SERVICE_URL: "http://order-service.unbox-app"
  PAYMENT_SERVICE_URL: "http://payment-service.unbox-app"
  TRADE_SERVICE_URL: "http://trade-service.unbox-app"
# 리소스 제한 (기본값)
resources:
  requests:
    memory: "512Mi"
    cpu: "500m"
  limits:
    memory: "1024Mi"
    cpu: "1000m"

# Argo Rollouts 설정
rollout:
  enabled: false  # 기본적으로 비활성화 (환경별로 활성화)
  strategy: "canary"  # Payment는 Canary + Manual Approval (Tier 0 - 무결성 최우선)
  
  # Health Check 설정
  healthCheck:
    enabled: true
    path: "/actuator/health"
    initialDelaySeconds: 30
    periodSeconds: 10
  
  # Canary 전략 설정 (Manual Approval)
  canary:
    steps:
      # Step 1: 1% 트래픽으로 초기 배포
      - setWeight: 1
      - pause:
          duration: 30s  # 30초간 자동 모니터링
      
      # Step 2: Manual Approval 대기 (Discord 알림)
      - pause: {}  # 무한 대기 - 수동 승인 필요
      
      # Step 3: 10% 트래픽
      - setWeight: 10
      - pause:
          duration: 30s
      
      # Step 4: 30% 트래픽
      - setWeight: 30
      - pause:
          duration: 30s
      
      # Step 5: 50% 트래픽
      - setWeight: 50
      - pause:
          duration: 30s
      
      # Step 6: 100% 트래픽 (완전 전환)
      - setWeight: 100
    
    # 분석 설정 (각 단계마다 실행)
    analysis:
      templates:
        - templateName: payment-success-rate
      startingStep: 1  # 1% 단계부터 분석 시작
      args:
        - name: service-name
          value: payment-service
    
    # 트래픽 라우팅
    trafficRouting:
      managedRoutes:
        - name: primary
      smi:
        trafficSplitName: payment-service-trafficsplit
        rootService: payment-service
  
  # Notification 설정 (Discord 알림)
  notifications:
    - trigger: rollout-paused
      send:
        - discord
    - trigger: rollout-completed
      send:
        - discord
    - trigger: rollout-aborted
      send:
        - discord

  # Feature Flag 설정
  featureFlag:
    enabled: false
