# Payment Service - Dev Environment
appName: payment-service
replicaCount: 1
image:
  repository: 632941626317.dkr.ecr.ap-northeast-2.amazonaws.com/unbox-dev-payment-repo
  tag: dev-dd01d387219bd830edf5278dd197b21102cf05a5
  pullPolicy: Always
# Ingress 활성화
ingress:
  enabled: false
linkerd:
  enabled: true # Linkerd Service Mesh 활성화
service:
  port: 80
  targetPort: 8085
  annotations:
    alb.ingress.kubernetes.io/healthcheck-path: "/payment/actuator/health"
containerPort: 8085
env:
  SERVER_PORT: "8085"
  SERVER_SERVLET_CONTEXT_PATH: "/payment"
  SPRING_JWT_SECRET:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: JWT_SECRET
  DB_DRIVER_CLASS_NAME: "org.postgresql.Driver"
  SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
  SPRING_JPA_SHOW_SQL: "false"
  TEST_CANARY_DEPLOYMENT: "v1"  # Canary 배포 테스트용
  SPRING_DATASOURCE_URL:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: RDS_ENDPOINT
  SPRING_DATASOURCE_USERNAME: "unbox_admin"
  SPRING_DATASOURCE_PASSWORD:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: DB_PASSWORD
  SPRING_DATA_REDIS_HOST:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: REDIS_ENDPOINT
  SPRING_DATA_REDIS_PORT: "6379"
  SPRING_DATA_REDIS_SSL: "true"
  SPRING_DATA_REDIS_PASSWORD:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: REDIS_PASSWORD
  SPRING_KAFKA_BOOTSTRAP_SERVERS:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: KAFKA_ENDPOINT
  # Tracing 활성화 (Tempo)
  MANAGEMENT_TRACING_ENABLED: "true"
  TEMPO_OTLP_ENDPOINT: "http://tempo.monitoring.svc.cluster.local:4318/v1/traces"
  # Toss Payments (SSM에서 가져옴)
  TOSS_SECRET_KEY:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: TOSS_SECRET_KEY
  TOSS_SECURITY_KEY:
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: TOSS_SECURITY_KEY
resources:
  requests:
    memory: "512Mi"
    cpu: "100m"
  limits:
    memory: "1Gi"
rollout:
  enabled: true
  strategy: "canary"
  
  # Notification 설정 (Discord 알림)
  notifications:
    - trigger: rollout-paused
      send:
        - discord
    - trigger: rollout-completed
      send:
        - discord
    - trigger: rollout-aborted
      send:
        - discord
  
  healthCheck:
    enabled: true
    path: "/payment/actuator/health"
    periodSeconds: 10
    startupProbe:
      failureThreshold: 60
      periodSeconds: 10
  
  canary:
    canaryService: payment-service-canary
    stableService: payment-service-stable
    steps:
      # Step 1: 1% 트래픽으로 초기 배포
      - setWeight: 1
      - pause:
          duration: 30s  # 30초간 자동 모니터링
      
      # Step 2: Manual Approval 대기 (Discord 알림)
      - pause: {}  # 무한 대기 - 수동 승인 필요
      
      # Step 3: 10% 트래픽
      - setWeight: 10
      - pause:
          duration: 30s
      
      # Step 4: 30% 트래픽
      - setWeight: 30
      - pause:
          duration: 30s
      
      # Step 5: 50% 트래픽
      - setWeight: 50
      - pause:
          duration: 30s
      
      # Step 6: 100% 트래픽 (완전 전환)
      - setWeight: 100
  
  # 분석 설정
  analysis:
    enabled: false  # Dev 환경에서는 비활성화
