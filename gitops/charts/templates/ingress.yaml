{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Values.appName }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ .Values.appName }}
  annotations:
    # 1. AWS Load Balancer Controller 기본 설정
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    
    # 2. [병합] 보안 그룹 자동화: Terraform에서 고정한 이름을 사용 (ID 몰라도 됨)
    alb.ingress.kubernetes.io/security-groups: {{ .Values.ingress.securityGroup | default "unbox-dev-alb-sg" | quote }}
    
    # 3. [병합] HTTPS/SSL 설정: 인증서 연결 및 포트 활성화
    {{- if .Values.ingress.certificateArn }}
    alb.ingress.kubernetes.io/certificate-arn: {{ .Values.ingress.certificateArn | quote }}
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    
    # 4. [병합] 보안 강화: HTTP로 오면 443(HTTPS)으로 자동 리다이렉트
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    {{- end }}
    
    # 5. 기존 설정: 상태 검사 및 그룹화
    alb.ingress.kubernetes.io/healthcheck-path: {{ .Values.rollout.healthCheck.path | default "/actuator/health" }}
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"
    
    # 6. 모든 서비스가 하나의 ALB를 공유하도록 설정
    alb.ingress.kubernetes.io/group.name: {{ .Values.ingress.groupName | default "unbox-dev" }}
    
    # 7. 추가 태그
    alb.ingress.kubernetes.io/tags: Environment=dev,ManagedBy=kubernetes
spec:
  ingressClassName: alb
  rules:
  - http:
      paths:
      - path: {{ .Values.ingress.path }}
        pathType: Prefix
        backend:
          service:
            name: {{ .Values.appName }}
            port:
              number: {{ .Values.service.port }}
{{- end }}
